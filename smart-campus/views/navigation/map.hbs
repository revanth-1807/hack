<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>Campus Map</h1>
    <div>
        <button onclick="showCurrentLocation()" class="btn btn-info">
            <i class="fas fa-location-arrow"></i> My Location
        </button>
        <a href="/navigation/route" class="btn btn-primary">
            <i class="fas fa-route"></i> Get Directions
        </a>
        {{#if (eq user.role 'admin')}}
        <a href="/navigation/admin/buildings" class="btn btn-warning">
            <i class="fas fa-cog"></i> Manage Buildings
        </a>
        {{/if}}
    </div>
</div>

<div class="card">
    <div style="text-align: center; padding: 1.5rem; background: #f8f9fa; border-radius: 8px 8px 0 0;">
        <i class="fas fa-map-marked-alt" style="font-size: 3rem; color: #007bff; margin-bottom: 0.5rem;"></i>
        <h2>Interactive Campus Map</h2>
        <p>Explore our campus buildings and get directions</p>
    </div>

    <!-- Map Search Box -->
    <div style="padding: 1rem; background: #fff; border-bottom: 1px solid #eee;">
        <div class="input-group">
            <input type="text" id="map-search-input" class="form-control" placeholder="Search for buildings or locations...">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" onclick="focusOnSearch()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Leaflet Map Container -->
    <div id="map" style="height: 500px; width: 100%;"></div>

    <!-- Directions Panel -->
    <div id="directions-panel" style="display: none; padding: 1rem; background: #f8f9fa; border-top: 1px solid #eee;">
        <h4>Directions</h4>
        <div id="directions-content"></div>
        <button onclick="hideDirections()" class="btn btn-sm btn-secondary mt-2">
            <i class="fas fa-times"></i> Close Directions
        </button>
    </div>

    <!-- Building List Toggle -->
    <div style="padding: 1rem; text-align: center;">
        <button id="toggle-buildings-btn" class="btn btn-outline-primary" onclick="toggleBuildingList()">
            <i class="fas fa-list"></i> Show Building List
        </button>
    </div>

    <!-- Building List -->
    <div id="building-list" style="display: none; padding: 1rem;">
        <h4>Campus Buildings</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            {{#each buildings}}
            <div class="card building-card">
                <div style="text-align: center; padding: 1rem;">
                    <i class="fas fa-building" style="font-size: 2rem; color: #007bff; margin-bottom: 0.5rem;"></i>
                    <h5>{{name}}</h5>
                    <p style="color: #666; margin-bottom: 0.5rem; font-size: 0.9rem;">{{category}}</p>
                    <div class="badge badge-primary mb-2">{{code}}</div>
                    <div>
                        <a href="/navigation/building/{{_id}}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-info-circle"></i> Details
                        </a>
                        <button onclick="getDirectionsToBuilding('{{_id}}')" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-directions"></i> Directions
                        </button>
                    </div>
                </div>
            </div>
            {{/each}}
        </div>
    </div>
</div>

<!-- Legend and Quick Navigation omitted for brevity (keep as is) -->

<style>
.building-card {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}
.building-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.building-info-window { max-width: 250px; }
.building-info-window h3 { margin:0 0 10px 0; color:#007bff; font-size:1.1rem; }
.building-info-window p { margin:5px 0; font-size:0.9rem; }
.building-info-window .btn { margin:2px; font-size:0.8rem; }
</style>

<script>
let map;

// Initialize the map at user location or fallback
function initMap() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map = L.map('map').setView([lat, lng], 16);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add user location marker
            L.marker([lat, lng]).addTo(map).bindPopup("You are here").openPopup();

            addBuildingMarkers();
        }, function(error) {
            console.error("Geolocation error:", error);
            // fallback coordinates if user denies location
            map = L.map('map').setView([{{mapCenter.lat}}, {{mapCenter.lng}}], {{mapZoom}});
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            addBuildingMarkers();
        });
    } else {
        alert("Geolocation not supported, showing default map.");
        map = L.map('map').setView([{{mapCenter.lat}}, {{mapCenter.lng}}], {{mapZoom}});
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        addBuildingMarkers();
    }
}

// Add all building markers
function addBuildingMarkers() {
    const buildingData = JSON.parse('{{buildingData}}');
    buildingData.forEach(function(building) {
        L.marker([building.coordinates.lat, building.coordinates.lng])
            .addTo(map)
            .bindPopup('<strong>' + building.name + '</strong><br>' + building.description + '<br><a href="/navigation/building/' + building.id + '">View Details</a>');
    });
}

// Show current location on button click
function showCurrentLocation() {
    if (!map) return;
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map.setView([lat, lng], 18);
            L.marker([lat, lng]).addTo(map).bindPopup("You are here").openPopup();
        }, function(error) {
            alert("Unable to fetch your location.");
        });
    } else {
        alert("Geolocation not supported by your browser.");
    }
}

// Toggle building list
function toggleBuildingList() {
    const buildingList = document.getElementById('building-list');
    const toggleBtn = document.getElementById('toggle-buildings-btn');
    
    if (buildingList.style.display === 'none') {
        buildingList.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-times"></i> Hide Building List';
        toggleBtn.classList.remove('btn-outline-primary');
        toggleBtn.classList.add('btn-outline-secondary');
    } else {
        buildingList.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-list"></i> Show Building List';
        toggleBtn.classList.remove('btn-outline-secondary');
        toggleBtn.classList.add('btn-outline-primary');
    }
}

function focusOnSearch() {
    document.getElementById('map-search-input').focus();
}

function hideDirections() {
    document.getElementById('directions-panel').style.display = 'none';
    if (map && map.directionsRenderer) {
        map.directionsRenderer.setDirections({routes: []});
    }
}

// Initialize map on page load
window.onload = initMap;
</script>
